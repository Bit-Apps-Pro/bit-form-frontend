!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).filepond_plugin_image_preview=t()}(this,(function(){"use strict";
/*!
   * FilePondPluginImagePreview 4.6.11
   * Licensed under MIT, https://opensource.org/licenses/MIT/
   * Please visit https://pqina.nl/filepond/ for details.
   */const e=(e,t)=>r(e.x*t,e.y*t),t=(e,t)=>r(e.x+t.x,e.y+t.y),i=(e,t,i)=>{const a=Math.cos(t),o=Math.sin(t),n=r(e.x-i.x,e.y-i.y);return r(i.x+a*n.x-o*n.y,i.y+o*n.x+a*n.y)},r=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return{x:e,y:t}},a=function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=arguments.length>3?arguments[3]:void 0;return"string"==typeof e?parseFloat(e)*i:"number"==typeof e?e*(r?t[r]:Math.min(t.width,t.height)):void 0},o=e=>null!=e,n=(e,t)=>Object.keys(t).forEach((i=>e.setAttribute(i,t[i]))),s=(e,t)=>{const i=document.createElementNS("http://www.w3.org/2000/svg",e);return t&&n(i,t),i},l={contain:"xMidYMid meet",cover:"xMidYMid slice"},c={left:"start",center:"middle",right:"end"},h=e=>t=>s(e,{id:t.id}),d={image:e=>{const t=s("image",{id:e.id,"stroke-linecap":"round","stroke-linejoin":"round",opacity:"0"});return t.onload=()=>{t.setAttribute("opacity",e.opacity||1)},t.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",e.src),t},rect:h("rect"),ellipse:h("ellipse"),text:h("text"),path:h("path"),line:e=>{const t=s("g",{id:e.id,"stroke-linecap":"round","stroke-linejoin":"round"}),i=s("line");t.appendChild(i);const r=s("path");t.appendChild(r);const a=s("path");return t.appendChild(a),t}},g={rect:e=>n(e,{...e.rect,...e.styles}),ellipse:e=>{const t=e.rect.x+.5*e.rect.width,i=e.rect.y+.5*e.rect.height,r=.5*e.rect.width,a=.5*e.rect.height;return n(e,{cx:t,cy:i,rx:r,ry:a,...e.styles})},image:(e,t)=>{n(e,{...e.rect,...e.styles,preserveAspectRatio:l[t.fit]||"none"})},text:(e,t,i,r)=>{const o=a(t.fontSize,i,r),s=t.fontFamily||"sans-serif",l=t.fontWeight||"normal",h=c[t.textAlign]||"start";n(e,{...e.rect,...e.styles,"stroke-width":0,"font-weight":l,"font-size":o,"font-family":s,"text-anchor":h}),e.text!==t.text&&(e.text=t.text,e.textContent=t.text.length?t.text:" ")},path:(e,t,i,r)=>{var o;n(e,{...e.styles,fill:"none",d:(o=t.points.map((e=>({x:a(e.x,i,r,"width"),y:a(e.y,i,r,"height")}))),o.map(((e,t)=>`${0===t?"M":"L"} ${e.x} ${e.y}`)).join(" "))})},line:(o,s,l,c)=>{n(o,{...o.rect,...o.styles,fill:"none"});const h=o.childNodes[0],d=o.childNodes[1],g=o.childNodes[2],p=o.rect,m={x:o.rect.x+o.rect.width,y:o.rect.y+o.rect.height};if(n(h,{x1:p.x,y1:p.y,x2:m.x,y2:m.y}),!s.lineDecoration)return;d.style.display="none",g.style.display="none";const u=(e=>{const t=Math.sqrt(e.x*e.x+e.y*e.y);return 0===t?{x:0,y:0}:r(e.x/t,e.y/t)})({x:m.x-p.x,y:m.y-p.y}),f=a(.05,l,c);if(-1!==s.lineDecoration.indexOf("arrow-begin")){const r=e(u,f),a=t(p,r),o=i(p,2,a),s=i(p,-2,a);n(d,{style:"display:block;",d:`M${o.x},${o.y} L${p.x},${p.y} L${s.x},${s.y}`})}if(-1!==s.lineDecoration.indexOf("arrow-end")){const r=e(u,-f),a=t(m,r),o=i(m,2,a),s=i(m,-2,a);n(g,{style:"display:block;",d:`M${o.x},${o.y} L${m.x},${m.y} L${s.x},${s.y}`})}}},p=["x","y","left","top","right","bottom","width","height"],m=e=>{const[t,i]=e,r=i.points?{}:p.reduce(((e,t)=>{var r;return e[t]="string"==typeof(r=i[t])&&/%/.test(r)?parseFloat(r)/100:r,e}),{});return[t,{zIndex:0,...i,...r}]},u=(e,t)=>e[1].zIndex>t[1].zIndex?1:e[1].zIndex<t[1].zIndex?-1:0,f=(e,t)=>({x:e,y:t}),E=(e,t)=>f(e.x-t.x,e.y-t.y),y=(e,t)=>Math.sqrt(((e,t)=>((e,t)=>e.x*t.x+e.y*t.y)(E(e,t),E(e,t)))(e,t)),w=(e,t)=>{const i=e,r=t,a=1.5707963267948966-t,o=Math.sin(1.5707963267948966),n=Math.sin(r),s=Math.sin(a),l=Math.cos(a),c=i/o;return f(l*(c*n),l*(c*s))},_=function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;const r=e.height/e.width;let a=1,o=t,n=1,s=r;s>o&&(s=o,n=s/r);const l=Math.max(a/n,o/s),c=e.width/(i*l*n),h=c*t;return{width:c,height:h}},I=(e,t,i,r)=>{const a=r.x>.5?1-r.x:r.x,o=r.y>.5?1-r.y:r.y,n=2*a*e.width,s=2*o*e.height,l=((e,t)=>{const i=e.width,r=e.height,a=w(i,t),o=w(r,t),n=f(e.x+Math.abs(a.x),e.y-Math.abs(a.y)),s=f(e.x+e.width+Math.abs(o.y),e.y+Math.abs(o.x)),l=f(e.x-Math.abs(o.y),e.y+e.height-Math.abs(o.x));return{width:y(n,s),height:y(n,l)}})(t,i);return Math.max(l.width/n,l.height/s)},M=(e,t)=>{let i=e.width,r=i*t;return r>e.height&&(r=e.height,i=r/t),{x:.5*(e.width-i),y:.5*(e.height-r),width:i,height:r}},x={type:"spring",stiffness:.5,damping:.45,mass:10};let T=0;const A=function(){self.onmessage=e=>{createImageBitmap(e.data.message.file).then((t=>{self.postMessage({id:e.data.id,message:t},[t])}))}},R=function(){self.onmessage=e=>{const t=e.data.message.imageData,i=e.data.message.colorMatrix,r=t.data,a=r.length,o=i[0],n=i[1],s=i[2],l=i[3],c=i[4],h=i[5],d=i[6],g=i[7],p=i[8],m=i[9],u=i[10],f=i[11],E=i[12],y=i[13],w=i[14],_=i[15],I=i[16],M=i[17],x=i[18],T=i[19];let A=0,R=0,v=0,C=0,D=0;for(;A<a;A+=4)R=r[A]/255,v=r[A+1]/255,C=r[A+2]/255,D=r[A+3]/255,r[A]=Math.max(0,Math.min(255*(R*o+v*n+C*s+D*l+c),255)),r[A+1]=Math.max(0,Math.min(255*(R*h+v*d+C*g+D*p+m),255)),r[A+2]=Math.max(0,Math.min(255*(R*u+v*f+C*E+D*y+w),255)),r[A+3]=Math.max(0,Math.min(255*(R*_+v*I+C*M+D*x+T),255));self.postMessage({id:e.data.id,message:t},[t.data.buffer])}},v={1:()=>[1,0,0,1,0,0],2:e=>[-1,0,0,1,e,0],3:(e,t)=>[-1,0,0,-1,e,t],4:(e,t)=>[1,0,0,-1,0,t],5:()=>[0,1,1,0,0,0],6:(e,t)=>[0,1,-1,0,t,0],7:(e,t)=>[0,-1,-1,0,t,e],8:e=>[0,-1,1,0,0,e]},C=e=>/^image/.test(e.type)&&!/svg/.test(e.type),D=e=>{const t=Math.min(10/e.width,10/e.height),i=document.createElement("canvas"),r=i.getContext("2d"),a=i.width=Math.ceil(e.width*t),o=i.height=Math.ceil(e.height*t);r.drawImage(e,0,0,a,o);let n=null;try{n=r.getImageData(0,0,a,o).data}catch(e){return null}const s=n.length;let l=0,c=0,h=0,d=0;for(;d<s;d+=4)l+=n[d]*n[d],c+=n[d+1]*n[d+1],h+=n[d+2]*n[d+2];return l=G(l,s),c=G(c,s),h=G(h,s),{r:l,g:c,b:h}},G=(e,t)=>Math.floor(Math.sqrt(e/(t/4))),P=e=>{const{addFilter:t,utils:i}=e,{Type:r,createRoute:n,isFile:s}=i,l=(e=>{const t=e.utils.createView({name:"image-preview-overlay",tag:"div",ignoreRect:!0,create:e=>{let{root:t,props:i}=e,r='<svg width="500" height="200" viewBox="0 0 500 200" preserveAspectRatio="none">\n    <defs>\n        <radialGradient id="gradient-__UID__" cx=".5" cy="1.25" r="1.15">\n            <stop offset=\'50%\' stop-color=\'#000000\'/>\n            <stop offset=\'56%\' stop-color=\'#0a0a0a\'/>\n            <stop offset=\'63%\' stop-color=\'#262626\'/>\n            <stop offset=\'69%\' stop-color=\'#4f4f4f\'/>\n            <stop offset=\'75%\' stop-color=\'#808080\'/>\n            <stop offset=\'81%\' stop-color=\'#b1b1b1\'/>\n            <stop offset=\'88%\' stop-color=\'#dadada\'/>\n            <stop offset=\'94%\' stop-color=\'#f6f6f6\'/>\n            <stop offset=\'100%\' stop-color=\'#ffffff\'/>\n        </radialGradient>\n        <mask id="mask-__UID__">\n            <rect x="0" y="0" width="500" height="200" fill="url(#gradient-__UID__)"></rect>\n        </mask>\n    </defs>\n    <rect x="0" width="500" height="200" fill="currentColor" mask="url(#mask-__UID__)"></rect>\n</svg>';if(document.querySelector("base")){const e=new URL(window.location.href.replace(window.location.hash,"")).href;r=r.replace(/url\(\#/g,"url("+e+"#")}T++,t.element.classList.add(`filepond--image-preview-overlay-${i.status}`),t.element.innerHTML=r.replace(/__UID__/g,T)},mixins:{styles:["opacity"],animations:{opacity:{type:"spring",mass:25}}}}),i=(e=>e.utils.createView({name:"image-preview",tag:"div",ignoreRect:!0,mixins:{apis:["image","crop","markup","resize","dirty","background"],styles:["translateY","scaleX","scaleY","opacity"],animations:{scaleX:x,scaleY:x,translateY:x,opacity:{type:"tween",duration:400}}},create:t=>{let{root:i,props:r}=t;i.ref.clip=i.appendChildView(i.createChildView((e=>e.utils.createView({name:"image-clip",tag:"div",ignoreRect:!0,mixins:{apis:["crop","markup","resize","width","height","dirty","background"],styles:["width","height","opacity"],animations:{opacity:{type:"tween",duration:250}}},didWriteView:function(e){let{root:t,props:i}=e;i.background&&(t.element.style.backgroundColor=i.background)},create:t=>{let{root:i,props:r}=t;i.ref.image=i.appendChildView(i.createChildView((e=>e.utils.createView({name:"image-canvas-wrapper",tag:"div",ignoreRect:!0,mixins:{apis:["crop","width","height"],styles:["originX","originY","translateX","translateY","scaleX","scaleY","rotateZ"],animations:{originX:x,originY:x,scaleX:x,scaleY:x,translateX:x,translateY:x,rotateZ:x}},create:t=>{let{root:i,props:r}=t;r.width=r.image.width,r.height=r.image.height,i.ref.bitmap=i.appendChildView(i.createChildView((e=>e.utils.createView({name:"image-bitmap",ignoreRect:!0,mixins:{styles:["scaleX","scaleY"]},create:e=>{let{root:t,props:i}=e;t.appendChild(i.image)}}))(e),{image:r.image}))},write:e=>{let{root:t,props:i}=e;const{flip:r}=i.crop,{bitmap:a}=t.ref;a.scaleX=r.horizontal?-1:1,a.scaleY=r.vertical?-1:1}}))(e),Object.assign({},r))),i.ref.createMarkup=()=>{i.ref.markup||(i.ref.markup=i.appendChildView(i.createChildView((e=>e.utils.createView({name:"image-preview-markup",tag:"svg",ignoreRect:!0,mixins:{apis:["width","height","crop","markup","resize","dirty"]},write:e=>{let{root:t,props:i}=e;if(!i.dirty)return;const{crop:r,resize:n,markup:s}=i,l=i.width,c=i.height;let h=r.width,p=r.height;if(n){const{size:e}=n;let t=e&&e.width,i=e&&e.height;const r=n.mode,a=n.upscale;t&&!i&&(i=t),i&&!t&&(t=i);const o=h<t&&p<i;if(!o||o&&a){let e=t/h,a=i/p;if("force"===r)h=t,p=i;else{let t;"cover"===r?t=Math.max(e,a):"contain"===r&&(t=Math.min(e,a)),h*=t,p*=t}}}const f={width:l,height:c};t.element.setAttribute("width",f.width),t.element.setAttribute("height",f.height);const E=Math.min(l/h,c/p);t.element.innerHTML="";const y=t.query("GET_IMAGE_PREVIEW_MARKUP_FILTER");s.filter(y).map(m).sort(u).forEach((e=>{const[i,r]=e,n=((e,t)=>d[e](t))(i,r);((e,t,i,r,n)=>{"path"!==t&&(e.rect=function(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=a(e.x,t,i,"width")||a(e.left,t,i,"width"),n=a(e.y,t,i,"height")||a(e.top,t,i,"height"),s=a(e.width,t,i,"width"),l=a(e.height,t,i,"height"),c=a(e.right,t,i,"width"),h=a(e.bottom,t,i,"height");return o(n)||(n=o(l)&&o(h)?t.height-l-h:h),o(r)||(r=o(s)&&o(c)?t.width-s-c:c),o(s)||(s=o(r)&&o(c)?t.width-r-c:0),o(l)||(l=o(n)&&o(h)?t.height-n-h:0),{x:r||0,y:n||0,width:s||0,height:l||0}}(i,r,n)),e.styles=((e,t,i)=>{const r=e.borderStyle||e.lineStyle||"solid",o=e.backgroundColor||e.fontColor||"transparent",n=e.borderColor||e.lineColor||"transparent",s=a(e.borderWidth||e.lineWidth,t,i);return{"stroke-linecap":e.lineCap||"round","stroke-linejoin":e.lineJoin||"round","stroke-width":s||0,"stroke-dasharray":"string"==typeof r?"":r.map((e=>a(e,t,i))).join(","),stroke:n,fill:o,opacity:e.opacity||1}})(i,r,n),g[t](e,i,r,n)})(n,i,r,f,E),t.element.appendChild(n)}))}}))(e),Object.assign({},r))))},i.ref.destroyMarkup=()=>{i.ref.markup&&(i.removeChildView(i.ref.markup),i.ref.markup=null)};const n=i.query("GET_IMAGE_PREVIEW_TRANSPARENCY_INDICATOR");null!==n&&(i.element.dataset.transparencyIndicator="grid"===n?n:"color")},write:e=>{let{root:t,props:i,shouldOptimize:r}=e;const{crop:a,markup:o,resize:n,dirty:s,width:l,height:c}=i;t.ref.image.crop=a;const h={x:0,y:0,width:l,height:c,center:{x:.5*l,y:.5*c}},d={width:t.ref.image.width,height:t.ref.image.height},g={x:a.center.x*d.width,y:a.center.y*d.height},p={x:h.center.x-d.width*a.center.x,y:h.center.y-d.height*a.center.y},m=2*Math.PI+a.rotation%(2*Math.PI),u=a.aspectRatio||d.height/d.width,f=void 0===a.scaleToFit||a.scaleToFit,E=I(d,M(h,u),m,f?a.center:{x:.5,y:.5}),y=a.zoom*E;o&&o.length?(t.ref.createMarkup(),t.ref.markup.width=l,t.ref.markup.height=c,t.ref.markup.resize=n,t.ref.markup.dirty=s,t.ref.markup.markup=o,t.ref.markup.crop=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{zoom:i,rotation:r,center:a,aspectRatio:o}=t;o||(o=e.height/e.width);const n=_(e,o,i),s={x:.5*n.width,y:.5*n.height},l={x:0,y:0,width:n.width,height:n.height,center:s},c=void 0===t.scaleToFit||t.scaleToFit,h=i*I(e,M(l,o),r,c?a:{x:.5,y:.5});return{widthFloat:n.width/h,heightFloat:n.height/h,width:Math.round(n.width/h),height:Math.round(n.height/h)}}(d,a)):t.ref.markup&&t.ref.destroyMarkup();const w=t.ref.image;if(r)return w.originX=null,w.originY=null,w.translateX=null,w.translateY=null,w.rotateZ=null,w.scaleX=null,void(w.scaleY=null);w.originX=g.x,w.originY=g.y,w.translateX=p.x,w.translateY=p.y,w.rotateZ=m,w.scaleX=y,w.scaleY=y}}))(e),{id:r.id,image:r.image,crop:r.crop,markup:r.markup,resize:r.resize,dirty:r.dirty,background:r.background}))},write:e=>{let{root:t,props:i,shouldOptimize:r}=e;const{clip:a}=t.ref,{image:o,crop:n,markup:s,resize:l,dirty:c}=i;if(a.crop=n,a.markup=s,a.resize=l,a.dirty=c,a.opacity=r?0:1,r||t.rect.element.hidden)return;const h=o.height/o.width;let d=n.aspectRatio||h;const g=t.rect.inner.width,p=t.rect.inner.height;let m=t.query("GET_IMAGE_PREVIEW_HEIGHT");const u=t.query("GET_IMAGE_PREVIEW_MIN_HEIGHT"),f=t.query("GET_IMAGE_PREVIEW_MAX_HEIGHT"),E=t.query("GET_PANEL_ASPECT_RATIO"),y=t.query("GET_ALLOW_MULTIPLE");E&&!y&&(m=g*E,d=E);let w=null!==m?m:Math.max(u,Math.min(g*d,f)),_=w/d;_>g&&(_=g,w=_*d),w>p&&(w=p,_=p/d),a.width=_,a.height=w}}))(e),{createWorker:r}=e.utils,n=(e,t,i)=>new Promise((a=>{e.ref.imageData||(e.ref.imageData=i.getContext("2d").getImageData(0,0,i.width,i.height));const o=(e=>{let t;try{t=new ImageData(e.width,e.height)}catch(i){t=document.createElement("canvas").getContext("2d").createImageData(e.width,e.height)}return t.data.set(new Uint8ClampedArray(e.data)),t})(e.ref.imageData);if(!t||20!==t.length)return i.getContext("2d").putImageData(o,0,0),a();const n=r(R);n.post({imageData:o,colorMatrix:t},(e=>{i.getContext("2d").putImageData(e,0,0),n.terminate(),a()}),[o.data.buffer])})),s=e=>{let{root:t,props:r,image:a}=e;const o=r.id,n=t.query("GET_ITEM",{id:o});if(!n)return;const s=n.getMetadata("crop")||{center:{x:.5,y:.5},flip:{horizontal:!1,vertical:!1},zoom:1,rotation:0,aspectRatio:null},l=t.query("GET_IMAGE_TRANSFORM_CANVAS_BACKGROUND_COLOR");let c,h,d=!1;t.query("GET_IMAGE_PREVIEW_MARKUP_SHOW")&&(c=n.getMetadata("markup")||[],h=n.getMetadata("resize"),d=!0);const g=t.appendChildView(t.createChildView(i,{id:o,image:a,crop:s,resize:h,markup:c,dirty:d,background:l,opacity:0,scaleX:1.15,scaleY:1.15,translateY:15}),t.childViews.length);t.ref.images.push(g),g.opacity=1,g.scaleX=1,g.scaleY=1,g.translateY=0,setTimeout((()=>{t.dispatch("DID_IMAGE_PREVIEW_SHOW",{id:o})}),250)},l=e=>{let{root:t}=e;t.ref.overlayShadow.opacity=1,t.ref.overlayError.opacity=0,t.ref.overlaySuccess.opacity=0},c=e=>{let{root:t}=e;t.ref.overlayShadow.opacity=.25,t.ref.overlayError.opacity=1};return e.utils.createView({name:"image-preview-wrapper",create:e=>{let{root:i}=e;i.ref.images=[],i.ref.imageData=null,i.ref.imageViewBin=[],i.ref.overlayShadow=i.appendChildView(i.createChildView(t,{opacity:0,status:"idle"})),i.ref.overlaySuccess=i.appendChildView(i.createChildView(t,{opacity:0,status:"success"})),i.ref.overlayError=i.appendChildView(i.createChildView(t,{opacity:0,status:"failure"}))},styles:["height"],apis:["height"],destroy:e=>{let{root:t}=e;t.ref.images.forEach((e=>{e.image.width=1,e.image.height=1}))},didWriteView:e=>{let{root:t}=e;t.ref.images.forEach((e=>{e.dirty=!1}))},write:e.utils.createRoute({DID_IMAGE_PREVIEW_DRAW:e=>{let{root:t}=e;const i=t.ref.images[t.ref.images.length-1];i.translateY=0,i.scaleX=1,i.scaleY=1,i.opacity=1},DID_IMAGE_PREVIEW_CONTAINER_CREATE:e=>{let{root:t,props:i}=e;const{id:r}=i,a=t.query("GET_ITEM",r);a&&((e,i)=>{let a=new Image;a.onload=()=>{const e=a.naturalWidth,i=a.naturalHeight;a=null,((e,i)=>{t.dispatch("DID_IMAGE_PREVIEW_CALCULATE_SIZE",{id:r,width:e,height:i})})(e,i)},a.src=e})(URL.createObjectURL(a.file))},DID_FINISH_CALCULATE_PREVIEWSIZE:e=>{let{root:t,props:i}=e;const{id:a}=i,o=t.query("GET_ITEM",a);if(!o)return;const l=URL.createObjectURL(o.file),c=()=>{var e;(e=l,new Promise(((t,i)=>{const r=new Image;r.crossOrigin="Anonymous",r.onload=()=>{t(r)},r.onerror=e=>{i(e)},r.src=e}))).then(h)},h=e=>{URL.revokeObjectURL(l);const r=(o.getMetadata("exif")||{}).orientation||-1;let{width:a,height:c}=e;if(!a||!c)return;r>=5&&r<=8&&([a,c]=[c,a]);const h=Math.max(1,.75*window.devicePixelRatio),d=t.query("GET_IMAGE_PREVIEW_ZOOM_FACTOR")*h,g=c/a,p=t.rect.element.width,m=t.rect.element.height;let u=p,f=u*g;g>1?(u=Math.min(a,p*d),f=u*g):(f=Math.min(c,m*d),u=f/g);const E=((e,t,i,r)=>{t=Math.round(t),i=Math.round(i);const a=document.createElement("canvas");a.width=t,a.height=i;const o=a.getContext("2d");return r>=5&&r<=8&&([t,i]=[i,t]),((e,t,i,r)=>{-1!==r&&e.transform.apply(e,v[r](t,i))})(o,t,i,r),o.drawImage(e,0,0,t,i),a})(e,u,f,r),y=()=>{const r=t.query("GET_IMAGE_PREVIEW_CALCULATE_AVERAGE_IMAGE_COLOR")?D(data):null;o.setMetadata("color",r,!0),"close"in e&&e.close(),t.ref.overlayShadow.opacity=1,s({root:t,props:i,image:E})},w=o.getMetadata("filter");w?n(t,w,E).then(y):y()};if((e=>{const t=window.navigator.userAgent.match(/Firefox\/([0-9]+)\./);return!((t?parseInt(t[1]):null)<=58)&&"createImageBitmap"in window&&C(e)})(o.file)){const e=r(A);e.post({file:o.file},(t=>{e.terminate(),t?h(t):c()}))}else c()},DID_UPDATE_ITEM_METADATA:e=>{let{root:t,props:i,action:r}=e;if(!/crop|filter|markup|resize/.test(r.change.key))return;if(!t.ref.images.length)return;const a=t.query("GET_ITEM",{id:i.id});if(a)if(/filter/.test(r.change.key)){const e=t.ref.images[t.ref.images.length-1];n(t,r.change.value,e.image)}else if(/crop|markup|resize/.test(r.change.key)){const e=a.getMetadata("crop"),r=t.ref.images[t.ref.images.length-1];if(e&&e.aspectRatio&&r.crop&&r.crop.aspectRatio&&Math.abs(e.aspectRatio-r.crop.aspectRatio)>1e-5){const e=(e=>{let{root:t}=e;const i=t.ref.images.shift();return i.opacity=0,i.translateY=-15,t.ref.imageViewBin.push(i),i})({root:t});s({root:t,props:i,image:(o=e.image,(l=l||document.createElement("canvas")).width=o.width,l.height=o.height,l.getContext("2d").drawImage(o,0,0),l)})}else(e=>{let{root:t,props:i}=e;const r=t.query("GET_ITEM",{id:i.id});if(!r)return;const a=t.ref.images[t.ref.images.length-1];a.crop=r.getMetadata("crop"),a.background=t.query("GET_IMAGE_TRANSFORM_CANVAS_BACKGROUND_COLOR"),t.query("GET_IMAGE_PREVIEW_MARKUP_SHOW")&&(a.dirty=!0,a.resize=r.getMetadata("resize"),a.markup=r.getMetadata("markup"))})({root:t,props:i})}var o,l},DID_THROW_ITEM_LOAD_ERROR:c,DID_THROW_ITEM_PROCESSING_ERROR:c,DID_THROW_ITEM_INVALID:c,DID_COMPLETE_ITEM_PROCESSING:e=>{let{root:t}=e;t.ref.overlayShadow.opacity=.25,t.ref.overlaySuccess.opacity=1},DID_START_ITEM_PROCESSING:l,DID_REVERT_ITEM_PROCESSING:l},(e=>{let{root:t}=e;const i=t.ref.imageViewBin.filter((e=>0===e.opacity));t.ref.imageViewBin=t.ref.imageViewBin.filter((e=>e.opacity>0)),i.forEach((e=>((e,t)=>{e.removeChildView(t),t.image.width=1,t.image.height=1,t._destroy()})(t,e))),i.length=0}))})})(e);return t("CREATE_VIEW",(e=>{const{is:t,view:i,query:r}=e;if(!t("file")||!r("GET_ALLOW_IMAGE_PREVIEW"))return;const a=e=>{let{root:t}=e;t.ref.shouldRescale=!0};i.registerWriter(n({DID_RESIZE_ROOT:a,DID_STOP_RESIZE:a,DID_LOAD_ITEM:e=>{let{root:t,props:a}=e;const{id:o}=a,n=r("GET_ITEM",o);if(!n||!s(n.file)||n.archived)return;const c=n.file;if(!(e=>/^image/.test(e.type))(c))return;if(!r("GET_IMAGE_PREVIEW_FILTER_ITEM")(n))return;const h="createImageBitmap"in(window||{}),d=r("GET_IMAGE_PREVIEW_MAX_FILE_SIZE");if(!h&&d&&c.size>d)return;t.ref.imagePreview=i.appendChildView(i.createChildView(l,{id:o}));const g=t.query("GET_IMAGE_PREVIEW_HEIGHT");g&&t.dispatch("DID_UPDATE_PANEL_HEIGHT",{id:n.id,height:g});const p=!h&&c.size>r("GET_IMAGE_PREVIEW_MAX_INSTANT_PREVIEW_FILE_SIZE");t.dispatch("DID_IMAGE_PREVIEW_CONTAINER_CREATE",{id:o},p)},DID_IMAGE_PREVIEW_CALCULATE_SIZE:e=>{let{root:t,action:i}=e;t.ref.imageWidth=i.width,t.ref.imageHeight=i.height,t.ref.shouldRescale=!0,t.ref.shouldDrawPreview=!0,t.dispatch("KICK")},DID_UPDATE_ITEM_METADATA:e=>{let{root:t,action:i}=e;"crop"===i.change.key&&(t.ref.shouldRescale=!0)}},(e=>{let{root:t,props:i}=e;t.ref.imagePreview&&(t.rect.element.hidden||(t.ref.shouldRescale&&(((e,t)=>{if(!e.ref.imagePreview)return;let{id:i}=t;const r=e.query("GET_ITEM",{id:i});if(!r)return;const a=e.query("GET_PANEL_ASPECT_RATIO"),o=e.query("GET_ITEM_PANEL_ASPECT_RATIO"),n=e.query("GET_IMAGE_PREVIEW_HEIGHT");if(a||o||n)return;let{imageWidth:s,imageHeight:l}=e.ref;if(!s||!l)return;const c=e.query("GET_IMAGE_PREVIEW_MIN_HEIGHT"),h=e.query("GET_IMAGE_PREVIEW_MAX_HEIGHT"),d=(r.getMetadata("exif")||{}).orientation||-1;if(d>=5&&d<=8&&([s,l]=[l,s]),!C(r.file)||e.query("GET_IMAGE_PREVIEW_UPSCALE")){const e=2048/s;s*=e,l*=e}const g=l/s,p=(r.getMetadata("crop")||{}).aspectRatio||g;let m=Math.max(c,Math.min(l,h));const u=e.rect.element.width,f=Math.min(u*p,m);e.dispatch("DID_UPDATE_PANEL_HEIGHT",{id:r.id,height:f})})(t,i),t.ref.shouldRescale=!1),t.ref.shouldDrawPreview&&(requestAnimationFrame((()=>{requestAnimationFrame((()=>{t.dispatch("DID_FINISH_CALCULATE_PREVIEWSIZE",{id:i.id})}))})),t.ref.shouldDrawPreview=!1)))})))})),{options:{allowImagePreview:[!0,r.BOOLEAN],imagePreviewFilterItem:[()=>!0,r.FUNCTION],imagePreviewHeight:[null,r.INT],imagePreviewMinHeight:[44,r.INT],imagePreviewMaxHeight:[256,r.INT],imagePreviewMaxFileSize:[null,r.INT],imagePreviewZoomFactor:[2,r.INT],imagePreviewUpscale:[!1,r.BOOLEAN],imagePreviewMaxInstantPreviewFileSize:[1e6,r.INT],imagePreviewTransparencyIndicator:[null,r.STRING],imagePreviewCalculateAverageImageColor:[!1,r.BOOLEAN],imagePreviewMarkupShow:[!0,r.BOOLEAN],imagePreviewMarkupFilter:[()=>!0,r.FUNCTION]}}};return"undefined"!=typeof window&&void 0!==window.document&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:P})),P}));
